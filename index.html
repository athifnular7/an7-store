<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AN7 - Study Smart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        navy: { 900: '#0a1628', 800: '#0f1d32', 700: '#1e3a5f' },
                        accent: { yellow: '#fbbf24', gold: '#f59e0b' }
                    }
                }
            }
        }
    </script>
    <style>
        .product-card:hover .product-actions { opacity: 1; transform: translateY(0); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .gradient-text { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-provider-btn { transition: all 0.2s; }
        .auth-provider-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .new-order-badge {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans antialiased flex flex-col min-h-screen">

    <!-- Navigation -->
    <nav class="fixed w-full z-50 bg-white/95 backdrop-blur-md border-b border-gray-200 transition-all duration-300" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="router.navigate('home')">
                    <span class="font-display text-2xl font-bold text-navy-900 tracking-tight">AN7</span>
                    <span class="ml-2 text-xs font-medium text-gray-500 hidden sm:block">Study Smart</span>
                </div>

                <div class="hidden md:flex flex-1 max-w-lg mx-8 relative">
                    <div class="relative w-full">
                        <input type="text" id="search-input" placeholder="Search calculators..." 
                            class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-navy-900 focus:border-transparent outline-none"
                            oninput="handleSearch(this.value)" onfocus="showSearchResults()" onblur="hideSearchResults()">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-3 top-2.5"></i>
                        <div id="search-results" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-80 overflow-y-auto z-50"></div>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <button onclick="router.navigate('shop')" class="hidden md:block text-gray-700 hover:text-navy-700 font-medium">Shop</button>
                    <button onclick="router.navigate('about')" class="hidden md:block text-gray-700 hover:text-navy-700 font-medium">About</button>
                    
                    <button id="admin-nav-btn" onclick="router.navigate('admin')" class="hidden relative text-purple-600 hover:text-purple-800" title="Admin Panel">
                        <i data-lucide="shield" class="w-5 h-5"></i>
                        <span id="admin-notification-dot" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                    </button>
                    
                    <button onclick="toggleCart()" class="relative text-gray-600 hover:text-navy-700">
                        <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                        <span id="cart-badge" class="absolute -top-2 -right-2 bg-accent-yellow text-navy-900 text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                    
                    <div class="relative" id="user-menu-container">
                        <button onclick="toggleUserMenu()" class="flex items-center gap-2 text-gray-600 hover:text-navy-700">
                            <div id="user-avatar" class="w-8 h-8 rounded-full bg-navy-900 text-white flex items-center justify-center text-sm font-bold hidden"></div>
                            <i data-lucide="user" class="w-6 h-6" id="user-icon"></i>
                        </button>
                        <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
                            <div id="guest-menu">
                                <button onclick="router.navigate('login'); toggleUserMenu()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Login</button>
                                <button onclick="router.navigate('register'); toggleUserMenu()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Sign Up</button>
                            </div>
                            <div id="user-menu" class="hidden">
                                <div class="px-4 py-2 text-sm text-gray-500 border-b border-gray-100" id="user-email-display"></div>
                                <button onclick="router.navigate('profile'); toggleUserMenu()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">My Profile</button>
                                <button onclick="router.navigate('orders'); toggleUserMenu()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">My Orders</button>
                                <button onclick="logout(); toggleUserMenu()" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-50">Logout</button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="md:hidden text-gray-600" onclick="toggleMobileMenu()">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-200">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <button onclick="router.navigate('home'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">Home</button>
                <button onclick="router.navigate('shop'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">Shop</button>
                <button onclick="router.navigate('about'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50">About</button>
                <div id="mobile-user-menu">
                    <button onclick="router.navigate('login'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-navy-900 hover:bg-gray-50">Login</button>
                    <button onclick="router.navigate('register'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-navy-900 hover:bg-gray-50">Sign Up</button>
                </div>
                <button id="mobile-admin-btn" onclick="router.navigate('admin'); toggleMobileMenu()" class="hidden w-full text-left px-3 py-2 text-base font-medium text-purple-700 hover:bg-purple-50">Admin Panel</button>
            </div>
        </div>
    </nav>

    <!-- New Order Alert Banner (Hidden by default) -->
    <div id="new-order-alert" class="hidden fixed top-16 left-0 right-0 bg-green-500 text-white py-2 px-4 z-40 text-center cursor-pointer" onclick="dismissNewOrder()">
        <div class="flex items-center justify-center gap-2">
            <i data-lucide="bell" class="w-5 h-5 animate-bounce"></i>
            <span class="font-bold">New Order Received!</span>
            <span class="text-sm opacity-90">Click to view</span>
        </div>
    </div>

    <main id="app" class="pt-16 flex-grow"></main>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onclick="toggleCart()"></div>
        <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl transform transition-transform translate-x-full flex flex-col" id="cart-panel">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-navy-900">Shopping Cart</h2>
                <button onclick="toggleCart()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
            <div class="border-t border-gray-200 p-6 space-y-4 bg-gray-50">
                <div class="flex justify-between text-base font-medium text-gray-900">
                    <p>Subtotal</p>
                    <p id="cart-subtotal">Rs. 0.00</p>
                </div>
                <div id="delivery-info" class="text-sm text-gray-600"></div>
                <div class="flex justify-between text-lg font-bold text-navy-900 border-t border-gray-300 pt-2">
                    <p>Total</p>
                    <p id="cart-total">Rs. 0.00</p>
                </div>
                <button onclick="checkoutFromCart()" class="w-full bg-navy-900 text-white py-3 px-4 rounded-lg font-medium hover:bg-navy-800 transition flex items-center justify-center gap-2">
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    Proceed to Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- Product Edit Modal -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" onclick="closeProductModal()">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title">Edit Product</h3>
                        <button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <form id="product-form" onsubmit="saveProduct(event)" class="space-y-4">
                        <input type="hidden" id="edit-product-id">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Product Name</label>
                            <input type="text" id="edit-name" required class="mt-1 block w-full rounded-lg border-gray-300 border px-3 py-2 focus:ring-navy-900 focus:border-navy-900">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Price (Rs)</label>
                                <input type="number" id="edit-price" required min="0" class="mt-1 block w-full rounded-lg border-gray-300 border px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Stock Qty</label>
                                <input type="number" id="edit-stock" required min="0" class="mt-1 block w-full rounded-lg border-gray-300 border px-3 py-2">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Main Product Image</label>
                            <div id="drop-zone-main" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-navy-900 transition cursor-pointer" onclick="document.getElementById('file-input-main').click()">
                                <input type="file" id="file-input-main" accept="image/*" class="hidden" onchange="handleImageSelect(event, 'main')">
                                <div id="upload-placeholder-main">
                                    <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                                    <p class="text-xs text-gray-600">Click to upload main image</p>
                                </div>
                                <img id="image-preview-main" class="hidden max-h-32 mx-auto rounded-lg">
                                <input type="hidden" id="edit-image-main">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Additional Images (Max 4)</label>
                            <div class="grid grid-cols-4 gap-2" id="additional-images-container">
                                <div id="drop-zone-add-1" class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center hover:border-navy-900 transition cursor-pointer aspect-square flex flex-col items-center justify-center" onclick="document.getElementById('file-input-add-1').click()">
                                    <input type="file" id="file-input-add-1" accept="image/*" class="hidden" onchange="handleImageSelect(event, 'add', 1)">
                                    <div id="upload-placeholder-add-1"><i data-lucide="plus" class="w-4 h-4 mx-auto text-gray-400"></i></div>
                                    <img id="image-preview-add-1" class="hidden w-full h-full object-cover rounded">
                                    <input type="hidden" id="edit-image-add-1">
                                </div>
                                <div id="drop-zone-add-2" class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center hover:border-navy-900 transition cursor-pointer aspect-square flex flex-col items-center justify-center" onclick="document.getElementById('file-input-add-2').click()">
                                    <input type="file" id="file-input-add-2" accept="image/*" class="hidden" onchange="handleImageSelect(event, 'add', 2)">
                                    <div id="upload-placeholder-add-2"><i data-lucide="plus" class="w-4 h-4 mx-auto text-gray-400"></i></div>
                                    <img id="image-preview-add-2" class="hidden w-full h-full object-cover rounded">
                                    <input type="hidden" id="edit-image-add-2">
                                </div>
                                <div id="drop-zone-add-3" class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center hover:border-navy-900 transition cursor-pointer aspect-square flex flex-col items-center justify-center" onclick="document.getElementById('file-input-add-3').click()">
                                    <input type="file" id="file-input-add-3" accept="image/*" class="hidden" onchange="handleImageSelect(event, 'add', 3)">
                                    <div id="upload-placeholder-add-3"><i data-lucide="plus" class="w-4 h-4 mx-auto text-gray-400"></i></div>
                                    <img id="image-preview-add-3" class="hidden w-full h-full object-cover rounded">
                                    <input type="hidden" id="edit-image-add-3">
                                </div>
                                <div id="drop-zone-add-4" class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center hover:border-navy-900 transition cursor-pointer aspect-square flex flex-col items-center justify-center" onclick="document.getElementById('file-input-add-4').click()">
                                    <input type="file" id="file-input-add-4" accept="image/*" class="hidden" onchange="handleImageSelect(event, 'add', 4)">
                                    <div id="upload-placeholder-add-4"><i data-lucide="plus" class="w-4 h-4 mx-auto text-gray-400"></i></div>
                                    <img id="image-preview-add-4" class="hidden w-full h-full object-cover rounded">
                                    <input type="hidden" id="edit-image-add-4">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="edit-description" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 border px-3 py-2"></textarea>
                        </div>
                        <div class="mt-6 flex gap-3">
                            <button type="button" onclick="closeProductModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                            <button type="submit" class="flex-1 bg-navy-900 text-white py-2 px-4 rounded-lg hover:bg-navy-800">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="gallery-modal" class="fixed inset-0 z-50 hidden bg-black/90 flex items-center justify-center p-4">
        <button onclick="closeGallery()" class="absolute top-4 right-4 text-white hover:text-gray-300">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <div class="max-w-4xl w-full">
            <img id="gallery-main-image" class="w-full max-h-[70vh] object-contain rounded-lg mb-4">
            <div id="gallery-thumbnails" class="flex justify-center gap-2 overflow-x-auto"></div>
        </div>
    </div>

    <a href="https://wa.me/94717627177" target="_blank" class="fixed bottom-6 right-6 z-40 bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition transform hover:scale-110 flex items-center gap-2 group">
        <i data-lucide="message-circle" class="w-6 h-6"></i>
        <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 whitespace-nowrap">Chat with us</span>
    </a>

    <div id="toast" class="fixed bottom-24 right-6 z-50 transform translate-y-20 opacity-0 transition-all duration-300 bg-navy-900 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
        <i data-lucide="check-circle" class="w-5 h-5 text-accent-yellow"></i>
        <span id="toast-message">Success</span>
    </div>

    <footer class="bg-navy-900 text-white mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <span class="font-display text-3xl font-bold text-accent-yellow">AN7</span>
                    <p class="mt-4 text-gray-300 text-sm">Study Smart<br>Premium Casio calculators for Sri Lankan students.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">Quick Links</h3>
                    <ul class="space-y-2 text-gray-300">
                        <li><button onclick="router.navigate('shop')" class="hover:text-accent-yellow transition">Shop All</button></li>
                        <li><button onclick="router.navigate('about')" class="hover:text-accent-yellow transition">About Us</button></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">Contact Us</h3>
                    <ul class="space-y-3 text-gray-300">
                        <li class="flex items-center gap-2"><i data-lucide="mail" class="w-5 h-5 text-accent-yellow"></i> athifnular@icloud.com</li>
                        <li class="flex items-center gap-2"><i data-lucide="phone" class="w-5 h-5 text-accent-yellow"></i> +94 71 762 7177</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">Account</h3>
                    <ul class="space-y-2 text-gray-300">
                        <li><button onclick="router.navigate('login')" class="hover:text-accent-yellow transition">Login</button></li>
                        <li><button onclick="router.navigate('register')" class="hover:text-accent-yellow transition">Register</button></li>
                        <li><button onclick="router.navigate('orders')" class="hover:text-accent-yellow transition">Track Order</button></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400 text-sm">
                <p>&copy; 2024 AN7 Study Smart. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDDu41W17u-mLwwMyfgsWQm2DtVm254fVc",
            authDomain: "store-c91db.firebaseapp.com",
            databaseURL: "https://store-c91db-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "store-c91db",
            storageBucket: "store-c91db.firebasestorage.app",
            messagingSenderId: "49770985076",
            appId: "1:49770985076:web:05d88ae9703943574f0321"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        const ADMIN_EMAIL = 'athifnular@icloud.com';
        const DELIVERY = { FREE_ITEM_COUNT: 2, CHARGE: 300 };

        const store = {
            currentUser: null,
            isAdmin: false,
            cart: JSON.parse(localStorage.getItem('an7_cart')) || [],
            products: [],
            orders: [],
            userOrders: [],
            authInitialized: false,
            lastOrderCount: 0
        };

        // Setup listeners ONCE at startup (not in views)
        function setupListeners() {
            // Products listener
            database.ref('products').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    store.products = Object.values(data);
                    if (router.currentRoute === 'shop' || router.currentRoute === 'home' || router.currentRoute === 'admin') {
                        router.refresh();
                    }
                }
            });

            // Orders listener for admin notifications
            database.ref('orders').on('value', (snapshot) => {
                const data = snapshot.val();
                const orders = data ? Object.values(data) : [];
                const previousCount = store.orders.length;
                store.orders = orders;
                
                // Show notification if new order arrived and admin is logged in
                if (store.isAdmin && previousCount > 0 && orders.length > previousCount) {
                    showNewOrderNotification();
                }
                
                if (router.currentRoute === 'admin') {
                    router.refresh();
                }
            });
        }

        // Auth State Listener
        auth.onAuthStateChanged((user) => {
            store.authInitialized = true;
            store.currentUser = user;
            
            if (user) {
                store.isAdmin = (user.email === ADMIN_EMAIL);
                if (store.isAdmin) {
                    document.getElementById('admin-nav-btn')?.classList.remove('hidden');
                    document.getElementById('mobile-admin-btn')?.classList.remove('hidden');
                    // Load admin order count for notification comparison
                    store.lastOrderCount = store.orders.length;
                }
                loadUserOrders(user.uid);
            } else {
                store.isAdmin = false;
                store.userOrders = [];
                document.getElementById('admin-nav-btn')?.classList.add('hidden');
                document.getElementById('mobile-admin-btn')?.classList.add('hidden');
            }
            
            updateUserUI();
            lucide.createIcons();
        });

        function showNewOrderNotification() {
            // Play sound
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PVanu87plHQUuh9Dz2YU2Bhxqv+zolEYNEE6p5O+4ZSAEMYrO89GFNwYdcfDr4ZJHDAtPp+XysWUeBjiS1/LQhTcGHXLv6uCPRgsNTKjl8bllHwU2jM7z0YU1Bhxw7+ngj0gNC1Ko5O+4ZSAFNo/M89CEMwYccO/r4I9IDQtRqOTyuWUfBTiOz/PShjUGG3Dw6uCPRwsLUqjl8blnHwU3jc7z0oU1Bxtw8OngjkcNC1Ko5fG4aCAF');
            audio.play().catch(e => console.log('Audio play failed'));
            
            // Show banner
            const alert = document.getElementById('new-order-alert');
            alert.classList.remove('hidden');
            
            // Show dot on admin button
            document.getElementById('admin-notification-dot')?.classList.remove('hidden');
            
            // Auto hide after 10 seconds
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 10000);
        }

        function dismissNewOrder() {
            document.getElementById('new-order-alert').classList.add('hidden');
            document.getElementById('admin-notification-dot')?.classList.add('hidden');
            router.navigate('admin');
        }

        function loadUserOrders(userId) {
            database.ref('orders').orderByChild('userId').equalTo(userId).on('value', (snapshot) => {
                const data = snapshot.val();
                store.userOrders = data ? Object.values(data) : [];
            });
        }

        function updateUserUI() {
            const user = store.currentUser;
            const avatar = document.getElementById('user-avatar');
            const icon = document.getElementById('user-icon');
            const guestMenu = document.getElementById('guest-menu');
            const userMenu = document.getElementById('user-menu');
            const emailDisplay = document.getElementById('user-email-display');
            const mobileUserMenu = document.getElementById('mobile-user-menu');
            
            if (user) {
                const initials = user.displayName ? user.displayName.split(' ').map(n => n[0]).join('').toUpperCase() : user.email[0].toUpperCase();
                avatar.textContent = initials;
                avatar.classList.remove('hidden');
                icon.classList.add('hidden');
                
                guestMenu.classList.add('hidden');
                userMenu.classList.remove('hidden');
                emailDisplay.textContent = user.email;
                
                if (mobileUserMenu) {
                    mobileUserMenu.innerHTML = `
                        <button onclick="router.navigate('profile'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-navy-900 hover:bg-gray-50">My Profile</button>
                        <button onclick="router.navigate('orders'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-navy-900 hover:bg-gray-50">My Orders</button>
                        <button onclick="logout(); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-red-600 hover:bg-gray-50">Logout</button>
                    `;
                }
            } else {
                avatar.classList.add('hidden');
                icon.classList.remove('hidden');
                guestMenu.classList.remove('hidden');
                userMenu.classList.add('hidden');
                
                if (mobileUserMenu) {
                    mobileUserMenu.innerHTML = `
                        <button onclick="router.navigate('login'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-navy-900 hover:bg-gray-50">Login</button>
                        <button onclick="router.navigate('register'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-navy-900 hover:bg-gray-50">Sign Up</button>
                    `;
                }
            }
        }

        const router = {
            currentRoute: 'home',
            params: {},
            navigate(route, params = {}, force = false) {
                if (this.currentRoute === route && !force && JSON.stringify(this.params) === JSON.stringify(params)) return;
                
                if (route === 'admin' && !store.isAdmin) {
                    if (!store.authInitialized) {
                        setTimeout(() => this.navigate(route, params), 500);
                        return;
                    }
                    if (!store.isAdmin) {
                        this.navigate('login');
                        return;
                    }
                }
                
                this.currentRoute = route;
                this.params = params;
                window.scrollTo(0, 0);
                this.render();
            },
            refresh() {
                this.render();
            },
            render() {
                const app = document.getElementById('app');
                app.innerHTML = '';
                
                switch(this.currentRoute) {
                    case 'home': app.appendChild(views.home()); break;
                    case 'shop': app.appendChild(views.shop(this.params)); break;
                    case 'product': app.appendChild(views.product(this.params.id)); break;
                    case 'checkout': app.appendChild(views.checkout()); break;
                    case 'about': app.appendChild(views.about()); break;
                    case 'admin': app.appendChild(views.admin()); break;
                    case 'login': app.appendChild(views.login()); break;
                    case 'register': app.appendChild(views.register()); break;
                    case 'profile': app.appendChild(views.profile()); break;
                    case 'orders': app.appendChild(views.orders()); break;
                    default: app.appendChild(views.home());
                }
                lucide.createIcons();
            }
        };

        const views = {
            home() {
                const div = document.createElement('div');
                div.innerHTML = `
                    <section class="relative bg-navy-900 overflow-hidden">
                        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=1920&q=80')] bg-cover bg-center opacity-10"></div>
                        <div class="absolute inset-0 bg-gradient-to-r from-navy-900 via-navy-900/95 to-transparent"></div>
                        <div class="relative max-w-7xl mx-auto px-4 py-24 lg:py-32">
                            <div class="lg:w-2/3">
                                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 border border-white/20 text-accent-yellow text-sm font-medium mb-6">
                                    <i data-lucide="star" class="w-4 h-4 fill-current"></i> Trusted by 10,000+ Students
                                </div>
                                <h1 class="text-5xl lg:text-7xl font-display font-bold text-white mb-6 leading-tight">
                                    Study <span class="gradient-text">Smart</span><br> with <span class="text-white">AN7</span>
                                </h1>
                                <p class="text-xl text-gray-300 mb-8">Premium Casio scientific calculators with official warranty. Serving Matara, Dehiwala, Peradeniya and islandwide.</p>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <button onclick="router.navigate('shop')" class="px-8 py-4 bg-accent-yellow text-navy-900 rounded-lg font-bold text-lg hover:bg-accent-gold transition flex items-center justify-center gap-2">Shop Now <i data-lucide="arrow-right" class="w-5 h-5"></i></button>
                                    <a href="https://wa.me/94717627177" target="_blank" class="px-8 py-4 bg-white/10 text-white border border-white/30 rounded-lg font-bold text-lg hover:bg-white/20 transition flex items-center justify-center gap-2"><i data-lucide="message-circle" class="w-5 h-5"></i> WhatsApp Order</a>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="py-16 bg-white">
                        <div class="max-w-7xl mx-auto px-4 grid grid-cols-2 md:grid-cols-4 gap-8">
                            ${[{icon:'shield',title:'1 Year Warranty',desc:'Official Casio warranty'},{icon:'refresh-cw',title:'1-1 Replacement',desc:'Defective unit replacement'},{icon:'graduation-cap',title:'Student Prices',desc:'Competitive pricing'},{icon:'truck',title:'Free Delivery 2+',desc:'Rs. 300 for single'}].map(f=>`<div class="text-center p-6 rounded-2xl bg-gray-50 hover:bg-navy-50 transition group cursor-pointer"><div class="w-14 h-14 mx-auto mb-4 bg-navy-900 rounded-xl flex items-center justify-center text-accent-yellow group-hover:scale-110 transition"><i data-lucide="${f.icon}" class="w-7 h-7"></i></div><h3 class="font-bold text-navy-900 mb-1">${f.title}</h3><p class="text-sm text-gray-600">${f.desc}</p></div>`).join('')}
                        </div>
                    </section>
                    <section class="py-20 bg-gray-50">
                        <div class="max-w-7xl mx-auto px-4">
                            <div class="flex justify-between items-end mb-12">
                                <div>
                                    <h2 class="text-3xl font-display font-bold text-navy-900 mb-2">Featured Calculators</h2>
                                    <p class="text-gray-600">Exam-approved models for engineering & science students</p>
                                </div>
                                <button onclick="router.navigate('shop')" class="hidden md:flex items-center gap-2 text-navy-700 font-medium hover:text-navy-900">View All <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${store.products.slice(0,3).map(p=>components.productCard(p)).join('')}
                            </div>
                        </div>
                    </section>
                `;
                return div;
            },

            shop(params={}) {
                const div = document.createElement('div');
                const searchQuery = params.search || '';
                const category = params.category || 'all';
                let filtered = store.products;
                if (searchQuery) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) || p.description.toLowerCase().includes(searchQuery.toLowerCase()));
                if (category !== 'all') filtered = filtered.filter(p => p.category === category);
                
                div.innerHTML = `
                    <div class="bg-navy-900 text-white py-16">
                        <div class="max-w-7xl mx-auto px-4">
                            <h1 class="text-4xl font-display font-bold mb-4">${searchQuery ? `Search: "${searchQuery}"` : 'Shop Calculators'}</h1>
                            <p class="text-gray-300">${filtered.length} products found</p>
                        </div>
                    </div>
                    <div class="max-w-7xl mx-auto px-4 py-8">
                        <div class="flex flex-wrap gap-4 mb-8">
                            <button onclick="router.navigate('shop')" class="px-4 py-2 rounded-lg ${category === 'all' ? 'bg-navy-900 text-white' : 'bg-gray-200 text-gray-700'}">All</button>
                            <button onclick="router.navigate('shop',{category:'calculator'})" class="px-4 py-2 rounded-lg ${category === 'calculator' ? 'bg-navy-900 text-white' : 'bg-gray-200 text-gray-700'}">Calculators</button>
                        </div>
                        ${filtered.length === 0 ? '<div class="text-center py-20 text-gray-500 text-lg">No products found</div>' : `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${filtered.map(p=>components.productCard(p)).join('')}</div>`}
                    </div>
                `;
                return div;
            },

            product(id) {
                const productId = parseInt(id) || id;
                const product = store.products.find(p => p.id == productId) || store.products[0];
                const relatedProducts = store.products.filter(p => p.id != productId).slice(0,3);
                const allImages = [product.image, ...(product.images || [])].filter(img => img);
                
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="bg-gray-50 min-h-screen py-8">
                        <div class="max-w-7xl mx-auto px-4">
                            <nav class="flex items-center gap-2 text-sm text-gray-600 mb-8">
                                <button onclick="router.navigate('home')" class="hover:text-navy-900">Home</button>
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                <button onclick="router.navigate('shop')" class="hover:text-navy-900">Shop</button>
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                <span class="text-navy-900 font-medium truncate max-w-xs">${product.name}</span>
                            </nav>
                            
                            <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-12">
                                <div class="grid md:grid-cols-2 gap-8 p-8">
                                    <div class="space-y-4">
                                        <div class="aspect-square bg-gray-100 rounded-xl overflow-hidden cursor-pointer" onclick="openGallery(0)">
                                            <img id="main-product-image" src="${product.image}" alt="${product.name}" class="w-full h-full object-cover hover:scale-105 transition duration-500">
                                        </div>
                                        ${allImages.length > 1 ? `<div class="flex gap-2 overflow-x-auto pb-2">${allImages.map((img,idx)=>`<button onclick="switchMainImage('${img}',${idx})" class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 ${idx===0?'border-navy-900':'border-gray-200'} hover:border-navy-900 transition"><img src="${img}" class="w-full h-full object-cover"></button>`).join('')}</div>` : ''}
                                    </div>
                                    
                                    <div class="space-y-6">
                                        <div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="px-3 py-1 bg-accent-yellow/20 text-navy-900 text-xs font-bold rounded-full">${product.badge}</span>
                                                ${product.stock > 0 ? `<span class="px-3 py-1 bg-green-100 text-green-800 text-xs font-bold rounded-full">In Stock (${product.stock})</span>` : '<span class="px-3 py-1 bg-red-100 text-red-800 text-xs font-bold rounded-full">Out of Stock</span>'}
                                            </div>
                                            <h1 class="text-3xl font-display font-bold text-navy-900 mb-2">${product.name}</h1>
                                            <div class="flex items-center gap-4">
                                                <span class="text-3xl font-bold text-navy-900">Rs. ${product.price.toLocaleString()}</span>
                                                ${product.originalPrice ? `<span class="text-xl text-gray-400 line-through">Rs. ${product.originalPrice.toLocaleString()}</span>` : ''}
                                            </div>
                                        </div>
                                        <p class="text-gray-600 leading-relaxed">${product.description}</p>
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <p class="text-sm text-blue-800 flex items-center gap-2"><i data-lucide="truck" class="w-4 h-4"></i> Free delivery for 2+ items | Rs. 300 for single item</p>
                                        </div>
                                        <div class="space-y-4 pt-4">
                                            <div class="flex items-center gap-4">
                                                <div class="flex items-center border border-gray-300 rounded-lg">
                                                    <button onclick="updateQty(-1)" class="px-4 py-2 hover:bg-gray-100 font-bold">-</button>
                                                    <input type="number" id="qty-input" value="1" min="1" max="${product.stock}" class="w-16 text-center border-x border-gray-300 py-2 focus:outline-none">
                                                    <button onclick="updateQty(1)" class="px-4 py-2 hover:bg-gray-100 font-bold">+</button>
                                                </div>
                                                <button onclick="addToCart(${product.id},parseInt(document.getElementById('qty-input').value))" class="flex-1 bg-navy-900 text-white py-3 rounded-lg font-bold hover:bg-navy-800 transition flex items-center justify-center gap-2">
                                                    <i data-lucide="shopping-cart" class="w-5 h-5"></i> Add to Cart
                                                </button>
                                            </div>
                                            <button onclick="buyOnWhatsApp(${product.id})" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition flex items-center justify-center gap-2">
                                                <i data-lucide="message-circle" class="w-5 h-5"></i> Order via WhatsApp
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${relatedProducts.length > 0 ? `
                            <div class="mt-12">
                                <h2 class="text-2xl font-bold text-navy-900 mb-6">You May Also Like</h2>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${relatedProducts.map(p => components.productCard(p)).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                window.currentProductImages = allImages;
                return div;
            },

            checkout() {
                const div = document.createElement('div');
                const subtotal = store.cart.reduce((sum,i)=>sum+(i.price*i.quantity),0);
                const itemCount = store.cart.reduce((sum,i)=>sum+i.quantity,0);
                const delivery = itemCount >= DELIVERY.FREE_ITEM_COUNT ? 0 : DELIVERY.CHARGE;
                const total = subtotal + delivery;
                
                div.innerHTML = `
                    <div class="max-w-7xl mx-auto px-4 py-12">
                        <div class="grid lg:grid-cols-2 gap-12">
                            <div>
                                <h1 class="text-3xl font-bold text-navy-900 mb-8">Checkout</h1>
                                ${!store.currentUser ? `
                                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                                    <div class="flex items-start gap-3">
                                        <i data-lucide="alert-circle" class="w-5 h-5 text-yellow-600 mt-0.5"></i>
                                        <div>
                                            <h4 class="font-bold text-yellow-900">Guest Checkout</h4>
                                            <p class="text-sm text-yellow-700">You're checking out as a guest. <button onclick="router.navigate('login')" class="underline font-medium">Login</button> to track your order.</p>
                                        </div>
                                    </div>
                                </div>
                                ` : `
                                <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
                                    <div class="flex items-start gap-3">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mt-0.5"></i>
                                        <div>
                                            <h4 class="font-bold text-green-900">Welcome back!</h4>
                                            <p class="text-sm text-green-700">Your order will be saved to your account.</p>
                                        </div>
                                    </div>
                                </div>
                                `}
                                
                                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                                    <div class="flex items-start gap-3">
                                        <i data-lucide="truck" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                                        <div>
                                            <h4 class="font-bold text-blue-900">Delivery Information</h4>
                                            <p class="text-sm text-blue-700">${itemCount >= DELIVERY.FREE_ITEM_COUNT ? `âœ“ You have ${itemCount} items. FREE delivery!` : `You have ${itemCount} item. Add ${DELIVERY.FREE_ITEM_COUNT - itemCount} more for FREE delivery (Rs. ${DELIVERY.CHARGE})`}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-8">
                                    <h3 class="font-bold text-gray-900 mb-4">Select Payment Method</h3>
                                    <div class="space-y-3">
                                        <label class="flex items-center p-4 border-2 border-navy-900 rounded-xl cursor-pointer bg-navy-50" onclick="selectPayment('cod')">
                                            <input type="radio" name="payment" value="cod" checked class="w-5 h-5 text-navy-900">
                                            <div class="ml-4 flex-1">
                                                <div class="flex items-center gap-2"><i data-lucide="banknote" class="w-5 h-5 text-navy-900"></i><span class="font-bold text-navy-900">Cash on Delivery</span></div>
                                                <p class="text-sm text-gray-600 mt-1">Pay when you receive the order</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-navy-900 transition" onclick="selectPayment('bank')">
                                            <input type="radio" name="payment" value="bank" class="w-5 h-5 text-navy-900">
                                            <div class="ml-4 flex-1">
                                                <div class="flex items-center gap-2"><i data-lucide="building-2" class="w-5 h-5 text-navy-900"></i><span class="font-bold text-gray-900">Bank Transfer</span></div>
                                                <p class="text-sm text-gray-600 mt-1">Transfer to BOC account</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="bank-details" class="hidden mb-8 bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                                    <h4 class="font-bold text-navy-900 mb-4 flex items-center gap-2"><i data-lucide="alert-circle" class="w-5 h-5"></i> Bank Transfer Details</h4>
                                    <div class="space-y-2 text-sm">
                                        <p><span class="font-medium">Bank:</span> Bank of Ceylon (BOC)</p>
                                        <p><span class="font-medium">Account Name:</span> M.M.M.A.Nular</p>
                                        <p><span class="font-medium">Account Number:</span> 94165151</p>
                                        <p><span class="font-medium">Branch:</span> Matara</p>
                                    </div>
                                </div>
                                
                                <form id="checkout-form" onsubmit="processCheckout(event)" class="space-y-6 bg-white rounded-xl shadow-sm p-6">
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div><label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label><input type="text" name="firstName" required class="w-full rounded-lg border-gray-300 border px-3 py-2"></div>
                                        <div><label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label><input type="text" name="lastName" required class="w-full rounded-lg border-gray-300 border px-3 py-2"></div>
                                    </div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Email *</label><input type="email" name="email" required class="w-full rounded-lg border-gray-300 border px-3 py-2" value="${store.currentUser ? store.currentUser.email : ''}"></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label><input type="tel" name="phone" required placeholder="07X XXX XXXX" class="w-full rounded-lg border-gray-300 border px-3 py-2"></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Delivery Address *</label><textarea name="address" required rows="3" class="w-full rounded-lg border-gray-300 border px-3 py-2"></textarea></div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                                        <select name="city" required class="w-full rounded-lg border-gray-300 border px-3 py-2">
                                            <option value="">Select City</option>
                                            <option value="Colombo">Colombo</option>
                                            <option value="Dehiwala">Dehiwala</option>
                                            <option value="Matara">Matara</option>
                                            <option value="Galle">Galle</option>
                                            <option value="Kandy">Kandy</option>
                                            <option value="Peradeniya">Peradeniya</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="w-full bg-navy-900 text-white py-4 rounded-lg font-bold text-lg hover:bg-navy-800 transition flex items-center justify-center gap-2">
                                        <i data-lucide="check-circle" class="w-5 h-5"></i> Place Order via WhatsApp
                                    </button>
                                </form>
                            </div>
                            <div>
                                <div class="bg-gray-50 rounded-xl p-6 sticky top-24">
                                    <h2 class="text-xl font-bold text-navy-900 mb-6">Order Summary</h2>
                                    <div class="space-y-4 mb-6">
                                        ${store.cart.map(item=>`<div class="flex justify-between items-center"><div class="flex items-center gap-3"><img src="${item.image}" class="w-12 h-12 rounded object-cover"><div><p class="font-medium text-sm">${item.name}</p><p class="text-xs text-gray-500">Qty: ${item.quantity}</p></div></div><span class="font-medium">Rs. ${(item.price*item.quantity).toLocaleString()}</span></div>`).join('')}
                                    </div>
                                    <div class="border-t border-gray-200 pt-4 space-y-2 text-sm">
                                        <div class="flex justify-between"><span>Subtotal (${itemCount} items)</span><span>Rs. ${subtotal.toLocaleString()}</span></div>
                                        <div class="flex justify-between"><span>Delivery</span><span class="${delivery===0?'text-green-600 font-medium':''}">${delivery===0?'FREE':'Rs. '+delivery.toLocaleString()}</span></div>
                                    </div>
                                    <div class="border-t border-gray-200 mt-4 pt-4 flex justify-between items-center">
                                        <span class="text-lg font-bold text-navy-900">Total</span>
                                        <span class="text-2xl font-bold text-navy-900">Rs. ${total.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return div;
            },

            admin() {
                if (!store.isAdmin) {
                    router.navigate('login');
                    return document.createElement('div');
                }
                
                const totalRevenue = store.orders.reduce((sum, o) => {
                    const total = parseFloat(o.total) || 0;
                    return sum + (isFinite(total) ? total : 0);
                }, 0);
                
                const pendingOrders = store.orders.filter(o => o.status === 'pending').length;
                
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="min-h-screen bg-gray-100 pb-20">
                        <header class="bg-navy-900 text-white shadow-lg">
                            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                                <h1 class="font-display font-bold text-xl">AN7 Admin Panel</h1>
                                <div class="flex items-center gap-4">
                                    <span class="text-sm text-gray-300">Welcome, Admin</span>
                                    <button onclick="logout()" class="text-sm bg-white/10 px-4 py-2 rounded-lg hover:bg-white/20">Logout</button>
                                </div>
                            </div>
                        </header>
                        <div class="max-w-7xl mx-auto px-4 py-8">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                                <div class="bg-white rounded-xl shadow-sm p-6">
                                    <h3 class="text-gray-600 text-sm font-medium mb-2">Total Products</h3>
                                    <p class="text-3xl font-bold text-navy-900">${store.products.length}</p>
                                </div>
                                <div class="bg-white rounded-xl shadow-sm p-6">
                                    <h3 class="text-gray-600 text-sm font-medium mb-2">Total Orders</h3>
                                    <p class="text-3xl font-bold text-navy-900">${store.orders.length}</p>
                                </div>
                                <div class="bg-white rounded-xl shadow-sm p-6">
                                    <h3 class="text-gray-600 text-sm font-medium mb-2">Pending Orders</h3>
                                    <p class="text-3xl font-bold text-orange-600">${pendingOrders}</p>
                                </div>
                                <div class="bg-white rounded-xl shadow-sm p-6">
                                    <h3 class="text-gray-600 text-sm font-medium mb-2">Revenue</h3>
                                    <p class="text-3xl font-bold text-green-600">Rs. ${totalRevenue.toLocaleString()}</p>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
                                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                                    <h2 class="text-xl font-bold text-navy-900">Products</h2>
                                    <button onclick="openProductModal()" class="bg-navy-900 text-white px-4 py-2 rounded-lg hover:bg-navy-800 font-medium">+ Add New Product</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead class="bg-gray-50 text-gray-600 text-sm">
                                            <tr>
                                                <th class="px-6 py-4">Product</th>
                                                <th class="px-6 py-4">Price</th>
                                                <th class="px-6 py-4">Stock</th>
                                                <th class="px-6 py-4 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                                            ${store.products.length===0 ? '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">No products found</td></tr>' : store.products.map(p => `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-6 py-4">
                                                        <div class="flex items-center gap-3">
                                                            <img src="${p.image}" class="w-12 h-12 rounded-lg object-cover">
                                                            <span class="font-medium text-navy-900">${p.name}</span>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4">Rs. ${p.price.toLocaleString()}</td>
                                                    <td class="px-6 py-4">
                                                        <span class="${p.stock < 5 ? 'text-red-600 font-bold' : ''}">${p.stock}</span>
                                                    </td>
                                                    <td class="px-6 py-4 text-right">
                                                        <button onclick="openProductModal(${p.id})" class="text-blue-600 hover:text-blue-800 mr-4 font-medium">Edit</button>
                                                        <button onclick="deleteProduct(${p.id})" class="text-red-600 hover:text-red-800 font-medium">Delete</button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                                <div class="p-6 border-b border-gray-200">
                                    <h2 class="text-xl font-bold text-navy-900">Recent Orders</h2>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead class="bg-gray-50 text-gray-600 text-sm">
                                            <tr>
                                                <th class="px-6 py-4">Order ID</th>
                                                <th class="px-6 py-4">Customer</th>
                                                <th class="px-6 py-4">Phone</th>
                                                <th class="px-6 py-4">Total</th>
                                                <th class="px-6 py-4">Status</th>
                                                <th class="px-6 py-4">Action</th>
                                                <th class="px-6 py-4">Date</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                                            ${store.orders.length === 0 ? '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No orders yet</td></tr>' : store.orders.slice().reverse().map(o => `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-6 py-4 font-medium">#${o.id}</td>
                                                    <td class="px-6 py-4">${o.customer || 'N/A'}</td>
                                                    <td class="px-6 py-4">${o.phone || 'N/A'}</td>
                                                    <td class="px-6 py-4 font-medium">Rs. ${(parseFloat(o.total) || 0).toLocaleString()}</td>
                                                    <td class="px-6 py-4">
                                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${o.status === 'delivered' ? 'bg-green-100 text-green-800' : o.status === 'processing' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${o.status || 'pending'}</span>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <select onchange="updateOrderStatus('${o.id}', this.value)" class="text-sm border border-gray-300 rounded px-2 py-1 focus:outline-none focus:border-navy-900">
                                                            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                            <option value="processing" ${o.status === 'processing' ? 'selected' : ''}>Processing</option>
                                                            <option value="delivered" ${o.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                                            <option value="cancelled" ${o.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                                        </select>
                                                    </td>
                                                    <td class="px-6 py-4 text-sm text-gray-500">${new Date(o.date).toLocaleDateString()}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return div;
            },

            about() {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="bg-navy-900 text-white py-24"><div class="max-w-4xl mx-auto px-4 text-center"><h1 class="text-5xl font-display font-bold mb-6">Our Story</h1><p class="text-xl text-gray-300">Study Smart with AN7</p></div></div>
                    <div class="max-w-4xl mx-auto px-4 py-16"><div class="bg-white rounded-2xl shadow-lg p-8"><h2 class="text-2xl font-bold text-navy-900 mb-4">The Beginning</h2><p class="text-gray-600">AN7 was born in 2022 when I was a 21-year-old engineering student at the University of Peradeniya. What started as selling calculators to friends quickly grew into serving thousands of students across Sri Lanka.</p></div></div>
                `;
                return div;
            },

            login() {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4">
                        <div class="max-w-md w-full bg-white rounded-2xl shadow-lg p-8">
                            <div class="text-center mb-8">
                                <h1 class="text-3xl font-display font-bold text-navy-900">Welcome Back</h1>
                                <p class="text-gray-600 mt-2">Sign in to your account</p>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                <button onclick="signInWithGoogle()" class="auth-provider-btn w-full flex items-center justify-center gap-3 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                    <span class="font-medium text-gray-700">Continue with Google</span>
                                </button>
                            </div>
                            
                            <div class="relative mb-6">
                                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or continue with email</span></div>
                            </div>
                            
                            <form onsubmit="handleLogin(event)" class="space-y-6">
                                <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" name="email" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-navy-900 outline-none"></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label><input type="password" name="password" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-navy-900 outline-none"></div>
                                <button type="submit" class="w-full bg-navy-900 text-white py-3 rounded-lg font-bold hover:bg-navy-800 transition">Sign In</button>
                            </form>
                            
                            <p class="mt-6 text-center text-sm text-gray-600">Don't have an account? <button onclick="router.navigate('register')" class="text-navy-900 font-medium hover:underline">Sign up</button></p>
                        </div>
                    </div>
                `;
                return div;
            },

            register() {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4">
                        <div class="max-w-md w-full bg-white rounded-2xl shadow-lg p-8">
                            <div class="text-center mb-8">
                                <h1 class="text-3xl font-display font-bold text-navy-900">Create Account</h1>
                                <p class="text-gray-600 mt-2">Join AN7 Study Smart</p>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                <button onclick="signInWithGoogle()" class="auth-provider-btn w-full flex items-center justify-center gap-3 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                    <span class="font-medium text-gray-700">Continue with Google</span>
                                </button>
                            </div>
                            
                            <div class="relative mb-6">
                                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or register with email</span></div>
                            </div>
                            
                            <form onsubmit="handleRegister(event)" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-gray-700 mb-2">First Name</label><input type="text" name="firstName" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-navy-900 outline-none"></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label><input type="text" name="lastName" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-navy-900 outline-none"></div>
                                </div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" name="email" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-navy-900 outline-none"></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label><input type="password" name="password" required minlength="6" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-navy-900 outline-none"></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label><input type="password" name="confirmPassword" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-navy-900 outline-none"></div>
                                <button type="submit" class="w-full bg-navy-900 text-white py-3 rounded-lg font-bold hover:bg-navy-800 transition">Create Account</button>
                            </form>
                            
                            <p class="mt-6 text-center text-sm text-gray-600">Already have an account? <button onclick="router.navigate('login')" class="text-navy-900 font-medium hover:underline">Sign in</button></p>
                        </div>
                    </div>
                `;
                return div;
            },

            profile() {
                if (!store.currentUser) {
                    router.navigate('login');
                    return document.createElement('div');
                }
                const user = store.currentUser;
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="max-w-4xl mx-auto px-4 py-12">
                        <h1 class="text-3xl font-bold text-navy-900 mb-8">My Profile</h1>
                        <div class="grid md:grid-cols-3 gap-8">
                            <div class="md:col-span-1">
                                <div class="bg-white rounded-2xl shadow-sm p-6 text-center">
                                    <div class="w-24 h-24 rounded-full bg-navy-900 text-white flex items-center justify-center text-3xl font-bold mx-auto mb-4">
                                        ${user.displayName ? user.displayName.split(' ').map(n => n[0]).join('').toUpperCase() : user.email[0].toUpperCase()}
                                    </div>
                                    <h2 class="font-bold text-lg text-gray-900">${user.displayName || 'User'}</h2>
                                    <p class="text-gray-600 text-sm mb-4">${user.email}</p>
                                    <button onclick="logout()" class="w-full bg-red-50 text-red-600 py-2 rounded-lg font-medium hover:bg-red-100 transition">Logout</button>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                                    <h3 class="font-bold text-lg text-gray-900 mb-4">Account Information</h3>
                                    <div class="space-y-4">
                                        <div class="grid md:grid-cols-2 gap-4">
                                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Display Name</label><input type="text" value="${user.displayName || ''}" readonly class="w-full px-4 py-2 rounded-lg border border-gray-300 bg-gray-50"></div>
                                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" value="${user.email}" readonly class="w-full px-4 py-2 rounded-lg border border-gray-300 bg-gray-50"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return div;
            },

            orders() {
                const div = document.createElement('div');
                const ordersToShow = store.currentUser ? store.userOrders : [];
                
                div.innerHTML = `
                    <div class="max-w-4xl mx-auto px-4 py-12">
                        <h1 class="text-3xl font-bold text-navy-900 mb-8">My Orders</h1>
                        ${!store.currentUser ? `
                        <div class="bg-white rounded-2xl shadow-sm p-8 text-center">
                            <i data-lucide="package" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
                            <h2 class="text-xl font-bold text-gray-900 mb-2">Please login to view your orders</h2>
                            <button onclick="router.navigate('login')" class="bg-navy-900 text-white px-6 py-3 rounded-lg font-bold hover:bg-navy-800 transition">Login</button>
                        </div>
                        ` : ordersToShow.length === 0 ? `
                        <div class="bg-white rounded-2xl shadow-sm p-8 text-center">
                            <i data-lucide="package" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
                            <h2 class="text-xl font-bold text-gray-900 mb-2">No orders yet</h2>
                            <button onclick="router.navigate('shop')" class="bg-navy-900 text-white px-6 py-3 rounded-lg font-bold hover:bg-navy-800 transition">Start Shopping</button>
                        </div>
                        ` : `
                        <div class="space-y-6">
                            ${ordersToShow.slice().reverse().map(o => `
                            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-200">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <p class="text-sm text-gray-500">Order ID</p>
                                        <p class="font-bold text-navy-900 text-lg">#${o.id}</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${o.status === 'delivered' ? 'bg-green-100 text-green-800' : o.status === 'processing' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${o.status || 'pending'}</span>
                                    </div>
                                </div>
                                <div class="border-t border-b border-gray-100 py-4 mb-4">
                                    <div class="space-y-2">
                                        ${o.items.map(item => `
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center gap-3">
                                                <img src="${item.image}" class="w-12 h-12 rounded object-cover">
                                                <div>
                                                    <p class="font-medium text-sm">${item.name}</p>
                                                    <p class="text-xs text-gray-500">Qty: ${item.quantity}</p>
                                                </div>
                                            </div>
                                            <span class="text-sm font-medium">Rs. ${(item.price * item.quantity).toLocaleString()}</span>
                                        </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-gray-500">
                                        <p>Ordered on ${new Date(o.date).toLocaleDateString()}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-500">Total</p>
                                        <p class="text-xl font-bold text-navy-900">Rs. ${(parseFloat(o.total) || 0).toLocaleString()}</p>
                                    </div>
                                </div>
                            </div>
                            `).join('')}
                        </div>
                        `}
                    </div>
                `;
                return div;
            }
        };

        const components = {
            productCard(product) {
                const discount = product.originalPrice ? Math.round((1 - product.price/product.originalPrice) * 100) : 0;
                return `
                    <div class="product-card group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-100 cursor-pointer" onclick="router.navigate('product',{id:${product.id}})">
                        <div class="relative aspect-square bg-gray-100 overflow-hidden">
                            <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" onerror="this.src='https://via.placeholder.com/400'">
                            ${discount > 0 ? `<span class="absolute top-4 left-4 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full">-${discount}%</span>` : ''}
                            <span class="absolute top-4 right-4 bg-white/90 text-navy-900 text-xs font-bold px-3 py-1 rounded-full">${product.badge}</span>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-navy-900 mb-2 line-clamp-2">${product.name}</h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-xl font-bold text-navy-900">Rs. ${product.price.toLocaleString()}</span>
                                    ${product.originalPrice ? `<span class="text-sm text-gray-400 line-through ml-2">Rs. ${product.originalPrice.toLocaleString()}</span>` : ''}
                                </div>
                                <span class="text-xs ${product.stock > 0 ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'} px-2 py-1 rounded-full font-medium">${product.stock > 0 ? 'In Stock' : 'Out of Stock'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        // Auth Functions
        function toggleUserMenu() {
            const menu = document.getElementById('user-dropdown');
            menu.classList.toggle('hidden');
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    showToast('Welcome ' + (result.user.displayName || result.user.email) + '!');
                    router.navigate('home');
                })
                .catch((error) => {
                    console.error('Google Sign In Error:', error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        showToast('Sign in cancelled', 'error');
                    } else if (error.code === 'auth/popup-blocked') {
                        showToast('Please allow popups for this site', 'error');
                    } else {
                        showToast('Google Sign In failed: ' + error.message, 'error');
                    }
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            const firstName = formData.get('firstName');
            const lastName = formData.get('lastName');

            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    return userCredential.user.updateProfile({
                        displayName: firstName + ' ' + lastName
                    });
                })
                .then(() => {
                    showToast('Account created successfully!');
                    router.navigate('home');
                })
                .catch((error) => {
                    showToast(error.message, 'error');
                });
        }

        function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const email = formData.get('email').toLowerCase().trim();
            const password = formData.get('password');

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    showToast('Welcome back!');
                    if (email === ADMIN_EMAIL) {
                        router.navigate('admin');
                    } else {
                        router.navigate('home');
                    }
                })
                .catch((error) => {
                    showToast('Invalid email or password', 'error');
                });
        }

        function logout() {
            auth.signOut().then(() => {
                showToast('Logged out successfully');
                router.navigate('home');
            });
        }

        // Cart Functions
        function checkoutFromCart() {
            if (store.cart.length === 0) {
                showToast('Your cart is empty', 'error');
                return;
            }
            toggleCart();
            router.navigate('checkout');
        }

        function handleSearch(query) {
            const resultsDiv = document.getElementById('search-results');
            if (!query.trim()) { resultsDiv.classList.add('hidden'); return; }
            const filtered = store.products.filter(p => p.name.toLowerCase().includes(query.toLowerCase()) || p.description.toLowerCase().includes(query.toLowerCase()));
            if (filtered.length === 0) { resultsDiv.innerHTML = '<div class="p-4 text-gray-500 text-center">No products found</div>'; }
            else {
                resultsDiv.innerHTML = filtered.slice(0,5).map(p=>`<div class="flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0" onclick="router.navigate('product',{id:${p.id}});hideSearchResults();"><img src="${p.image}" class="w-12 h-12 rounded object-cover"><div class="flex-1"><p class="font-medium text-navy-900 text-sm">${p.name}</p><p class="text-xs text-gray-500">Rs. ${p.price.toLocaleString()}</p></div></div>`).join('') + (filtered.length > 5 ? `<div class="p-3 text-center text-sm text-navy-900 font-medium cursor-pointer hover:bg-gray-50" onclick="router.navigate('shop',{search:'${query}'});hideSearchResults();">View all ${filtered.length} results</div>` : '');
            }
            resultsDiv.classList.remove('hidden');
        }

        function showSearchResults() { const input = document.getElementById('search-input'); if (input && input.value.trim()) document.getElementById('search-results').classList.remove('hidden'); }
        function hideSearchResults() { setTimeout(() => document.getElementById('search-results')?.classList.add('hidden'), 200); }
        function switchMainImage(src, idx) { document.getElementById('main-product-image').src = src; }
        function openGallery(startIndex) { const modal = document.getElementById('gallery-modal'); document.getElementById('gallery-main-image').src = window.currentProductImages[startIndex]; document.getElementById('gallery-thumbnails').innerHTML = window.currentProductImages.map((img,idx)=>`<button onclick="document.getElementById('gallery-main-image').src='${img}'" class="flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 ${idx===startIndex?'border-accent-yellow':'border-white'} hover:border-accent-yellow transition"><img src="${img}" class="w-full h-full object-cover"></button>`).join(''); modal.classList.remove('hidden'); }
        function closeGallery() { document.getElementById('gallery-modal').classList.add('hidden'); }

        function handleImageSelect(event, type, index = null) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { showToast('Image too large. Max 5MB', 'error'); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'main') {
                    document.getElementById('image-preview-main').src = e.target.result;
                    document.getElementById('image-preview-main').classList.remove('hidden');
                    document.getElementById('upload-placeholder-main').classList.add('hidden');
                    document.getElementById('edit-image-main').value = e.target.result;
                } else {
                    document.getElementById(`image-preview-add-${index}`).src = e.target.result;
                    document.getElementById(`image-preview-add-${index}`).classList.remove('hidden');
                    document.getElementById(`upload-placeholder-add-${index}`).classList.add('hidden');
                    document.getElementById(`edit-image-add-${index}`).value = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }

        function selectPayment(method) {
            document.querySelectorAll('input[name="payment"]').forEach(input => {
                const label = input.closest('label');
                if (input.value === method) { label.classList.add('border-navy-900', 'bg-navy-50'); label.classList.remove('border-gray-200'); }
                else { label.classList.remove('border-navy-900', 'bg-navy-50'); label.classList.add('border-gray-200'); }
            });
            const bankDetails = document.getElementById('bank-details');
            if (method === 'bank') bankDetails?.classList.remove('hidden'); else bankDetails?.classList.add('hidden');
        }

        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const panel = document.getElementById('cart-panel');
            if (sidebar.classList.contains('hidden')) { sidebar.classList.remove('hidden'); setTimeout(() => panel.classList.remove('translate-x-full'), 10); renderCart(); }
            else { panel.classList.add('translate-x-full'); setTimeout(() => sidebar.classList.add('hidden'), 300); }
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            const badge = document.getElementById('cart-badge');
            const subtotalEl = document.getElementById('cart-subtotal');
            const totalEl = document.getElementById('cart-total');
            const deliveryInfo = document.getElementById('delivery-info');
            const totalItems = store.cart.reduce((sum,item)=>sum+item.quantity,0);
            const subtotal = store.cart.reduce((sum,item)=>sum+(item.price*item.quantity),0);
            const delivery = totalItems >= DELIVERY.FREE_ITEM_COUNT ? 0 : DELIVERY.CHARGE;
            const total = subtotal + delivery;
            
            if (totalItems > 0) {
                badge.textContent = totalItems; badge.classList.remove('hidden');
                subtotalEl.textContent = `Rs. ${subtotal.toLocaleString()}`;
                totalEl.textContent = `Rs. ${total.toLocaleString()}`;
                deliveryInfo.innerHTML = totalItems >= DELIVERY.FREE_ITEM_COUNT ? '<span class="text-green-600 font-medium">âœ“ Free delivery (2+ items)</span>' : `Delivery: Rs. ${DELIVERY.CHARGE} (Add ${DELIVERY.FREE_ITEM_COUNT - totalItems} more for free)`;
                container.innerHTML = store.cart.map(item=>`<div class="flex gap-4 bg-gray-50 p-4 rounded-xl"><img src="${item.image}" class="w-20 h-20 object-cover rounded-lg"><div class="flex-1"><h4 class="font-medium text-navy-900">${item.name}</h4><p class="text-sm text-gray-600">Rs. ${item.price.toLocaleString()}</p><div class="flex items-center gap-3 mt-2"><button onclick="updateCartQty(${item.id},-1)" class="w-6 h-6 rounded bg-white border flex items-center justify-center hover:bg-gray-100">-</button><span>${item.quantity}</span><button onclick="updateCartQty(${item.id},1)" class="w-6 h-6 rounded bg-white border flex items-center justify-center hover:bg-gray-100">+</button><button onclick="removeFromCart(${item.id})" class="ml-auto text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div></div>`).join('');
            } else {
                badge.classList.add('hidden');
                subtotalEl.textContent = 'Rs. 0.00'; totalEl.textContent = 'Rs. 0.00'; deliveryInfo.innerHTML = '';
                container.innerHTML = `<div class="text-center text-gray-500 py-12"><i data-lucide="shopping-bag" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i><p>Your cart is empty</p><button onclick="router.navigate('shop'); toggleCart()" class="mt-4 text-navy-900 font-medium underline">Continue Shopping</button></div>`;
            }
            lucide.createIcons();
        }

        function addToCart(productId, qty = 1) {
            const product = store.products.find(p => p.id === productId);
            if (!product || product.stock < qty) { showToast('Insufficient stock', 'error'); return; }
            const existing = store.cart.find(item => item.id === productId);
            if (existing) {
                if (existing.quantity + qty > product.stock) { showToast('Maximum stock reached', 'error'); return; }
                existing.quantity += qty;
            } else {
                store.cart.push({ id: product.id, name: product.name, price: product.price, image: product.image, quantity: qty });
            }
            saveCart(); renderCart(); showToast('Added to cart');
        }

        function updateCartQty(productId, delta) {
            const item = store.cart.find(i => i.id === productId);
            const product = store.products.find(p => p.id === productId);
            if (item && product) {
                const newQty = item.quantity + delta;
                if (newQty <= 0) removeFromCart(productId);
                else if (newQty <= product.stock) { item.quantity = newQty; saveCart(); renderCart(); }
            }
        }

        function removeFromCart(productId) { store.cart = store.cart.filter(i => i.id !== productId); saveCart(); renderCart(); }
        function saveCart() { localStorage.setItem('an7_cart', JSON.stringify(store.cart)); }

        function processCheckout(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const itemCount = store.cart.reduce((sum,i)=>sum+i.quantity,0);
            const subtotal = store.cart.reduce((sum,i)=>sum+(i.price*i.quantity),0);
            const delivery = itemCount >= DELIVERY.FREE_ITEM_COUNT ? 0 : DELIVERY.CHARGE;
            const total = subtotal + delivery;
            
            const firstName = formData.get('firstName');
            const lastName = formData.get('lastName');
            const phone = formData.get('phone');
            const address = formData.get('address');
            const city = formData.get('city');
            const email = formData.get('email');
            
            const orderData = {
                id: Date.now().toString(),
                userId: store.currentUser ? store.currentUser.uid : 'guest_' + Date.now(),
                customer: `${firstName} ${lastName}`,
                email: email,
                phone: phone,
                address: address,
                city: city,
                items: [...store.cart],
                subtotal: subtotal,
                delivery: delivery,
                total: total,
                status: 'pending',
                date: new Date().toISOString(),
                paymentMethod: paymentMethod,
                notified: false
            };

            database.ref('orders/' + orderData.id).set(orderData)
                .then(() => {
                    const itemsList = store.cart.map(i => `â€¢ ${i.name} x${i.quantity} = Rs.${(i.price*i.quantity).toLocaleString()}`).join('%0A');
                    const message = `*NEW ORDER #${orderData.id}*%0A%0A` +
                                   `*Customer:* ${firstName} ${lastName}%0A` +
                                   `*Phone:* ${phone}%0A` +
                                   `*Email:* ${email}%0A` +
                                   `*Address:* ${address}, ${city}%0A%0A` +
                                   `*Items:*%0A${itemsList}%0A%0A` +
                                   `*Subtotal:* Rs.${subtotal.toLocaleString()}%0A` +
                                   `*Delivery:* ${delivery===0?'FREE':('Rs.'+delivery)}%0A` +
                                   `*Total:* Rs.${total.toLocaleString()}%0A` +
                                   `*Payment:* ${paymentMethod.toUpperCase()}`;
                    
                    store.cart = []; 
                    saveCart(); 
                    showToast('Order placed successfully! Opening WhatsApp...');
                    
                    setTimeout(() => {
                        window.open(`https://wa.me/94717627177?text=${message}`, '_blank');
                        router.navigate('orders');
                    }, 1000);
                })
                .catch((error) => {
                    console.error("Order save error:", error);
                    showToast('Error: ' + error.message, 'error');
                });
        }

        function buyOnWhatsApp(productId) {
            const product = store.products.find(p => p.id === productId);
            if (!product) return;
            const qty = parseInt(document.getElementById('qty-input')?.value || 1);
            const message = `Hi AN7, I want to buy:%0A${product.name} x${qty}%0ATotal: Rs. ${(product.price*qty).toLocaleString()}%0A%0AName:%0AAddress:`;
            window.open(`https://wa.me/94717627177?text=${message}`, '_blank');
        }

        // Admin Functions
        function openProductModal(productId = null) {
            const modal = document.getElementById('product-modal');
            document.getElementById('product-form').reset();
            document.getElementById('image-preview-main').classList.add('hidden');
            document.getElementById('upload-placeholder-main').classList.remove('hidden');
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`image-preview-add-${i}`)?.classList.add('hidden');
                document.getElementById(`upload-placeholder-add-${i}`)?.classList.remove('hidden');
                document.getElementById(`edit-image-add-${i}`).value = '';
            }
            
            if (productId) {
                const p = store.products.find(x => x.id === productId);
                if (!p) return;
                document.getElementById('modal-title').textContent = 'Edit Product';
                document.getElementById('edit-product-id').value = p.id;
                document.getElementById('edit-name').value = p.name;
                document.getElementById('edit-price').value = p.price;
                document.getElementById('edit-stock').value = p.stock;
                document.getElementById('edit-description').value = p.description || '';
                
                if (p.image) {
                    document.getElementById('image-preview-main').src = p.image;
                    document.getElementById('image-preview-main').classList.remove('hidden');
                    document.getElementById('upload-placeholder-main').classList.add('hidden');
                    document.getElementById('edit-image-main').value = p.image;
                }
                
                if (p.images) {
                    p.images.forEach((img, idx) => {
                        if (img && idx < 4) {
                            const i = idx + 1;
                            document.getElementById(`image-preview-add-${i}`).src = img;
                            document.getElementById(`image-preview-add-${i}`).classList.remove('hidden');
                            document.getElementById(`upload-placeholder-add-${i}`).classList.add('hidden');
                            document.getElementById(`edit-image-add-${i}`).value = img;
                        }
                    });
                }
            } else {
                document.getElementById('modal-title').textContent = 'Add Product';
                document.getElementById('edit-product-id').value = '';
            }
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeProductModal() { document.getElementById('product-modal').classList.add('hidden'); }

        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('edit-product-id').value;
            const productData = {
                name: document.getElementById('edit-name').value,
                price: parseFloat(document.getElementById('edit-price').value),
                stock: parseInt(document.getElementById('edit-stock').value),
                description: document.getElementById('edit-description').value || '',
                category: 'calculator',
                badge: id ? (store.products.find(p => p.id === parseInt(id))?.badge || 'New') : 'New',
                updatedAt: new Date().toISOString()
            };

            const mainImage = document.getElementById('edit-image-main').value;
            productData.image = mainImage || (id ? store.products.find(p => p.id === parseInt(id))?.image : 'https://via.placeholder.com/400');

            const additionalImages = [];
            for (let i = 1; i <= 4; i++) {
                const img = document.getElementById(`edit-image-add-${i}`).value;
                if (img) additionalImages.push(img);
            }
            productData.images = additionalImages;

            if (id) {
                productData.id = parseInt(id);
                database.ref('products/' + id).update(productData)
                    .then(() => { showToast('Product updated!'); closeProductModal(); })
                    .catch(err => showToast('Error: ' + err.message, 'error'));
            } else {
                const newId = Date.now();
                productData.id = newId;
                productData.createdAt = new Date().toISOString();
                database.ref('products/' + newId).set(productData)
                    .then(() => { showToast('Product added!'); closeProductModal(); })
                    .catch(err => showToast('Error: ' + err.message, 'error'));
            }
        }

        function updateOrderStatus(orderId, newStatus) {
            database.ref('orders/' + orderId).update({ status: newStatus })
                .then(() => {
                    showToast('Order status updated to ' + newStatus);
                })
                .catch(err => {
                    showToast('Error updating status: ' + err.message, 'error');
                });
        }

        function deleteProduct(id) {
            if (confirm('Delete this product?')) {
                database.ref('products/' + id).remove()
                    .then(() => { showToast('Product deleted'); })
                    .catch(err => showToast('Error: ' + err.message, 'error'));
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            msgEl.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function toggleMobileMenu() { document.getElementById('mobile-menu').classList.toggle('hidden'); }
        function updateQty(delta) {
            const input = document.getElementById('qty-input');
            if (!input) return;
            const newVal = parseInt(input.value) + delta;
            if (newVal >= 1 && newVal <= parseInt(input.max)) input.value = newVal;
        }

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('mobile-menu');
            const button = document.querySelector('[onclick="toggleMobileMenu()"]');
            if (menu && !menu.classList.contains('hidden') && !menu.contains(e.target) && !button?.contains(e.target)) {
                menu.classList.add('hidden');
            }
            
            const userMenu = document.getElementById('user-dropdown');
            const userButton = document.querySelector('[onclick="toggleUserMenu()"]');
            if (userMenu && !userMenu.classList.contains('hidden') && !userMenu.contains(e.target) && !userButton?.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupListeners();
            router.navigate('home');
            window.addEventListener('scroll', () => {
                const nav = document.getElementById('navbar');
                if (window.scrollY > 50) nav.classList.add('shadow-md'); else nav.classList.remove('shadow-md');
            });
        });
    </script>
</body>
</html>
